datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id
  email     String?
  name      String?
  image     String?
  createdAt DateTime @default(now())

  boards           Board[]
  flashcardDecks   FlashcardDeck[]
  flashcardReviews FlashcardReview[]
  pomodoroSessions PomodoroSession[]
  quizzes          Quiz[]
  quizAttempts     QuizAttempt[]    @relation("UserToQuizAttempts")
  embeddings       Embedding[]      @relation("UserToEmbeddings")
}

model Board {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  title       String
  description String?
  theme       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  columns Column[]
  tasks   Task[]

  @@index([userId])
}

model Column {
  id        String   @id @default(cuid())
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId   String
  name      String
  position  Int
  createdAt DateTime @default(now())

  tasks Task[]

  @@index([boardId])
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  DONE
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model Task {
  id                  String   @id @default(cuid())
  board               Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId             String
  column              Column   @relation(fields: [columnId], references: [id], onDelete: Cascade)
  columnId            String
  title               String
  descriptionMarkdown String   @default("")
  priority            TaskPriority @default(MEDIUM)
  status              TaskStatus   @default(TODO)
  estimatedPomodoros  Int?
  completedPomodoros  Int      @default(0)
  tags                String[] @default([])
  autoGenerated       Boolean  @default(false)
  enrichedAt          DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  project     Project? @relation(fields: [projectId], references: [id])
  projectId   String?

  note             Note?
  pomodoroSessions PomodoroSession[]
  embeddings       Embedding[]        @relation("TaskToEmbeddings")

  @@index([boardId])
  @@index([columnId])
  @@index([status])
}

model Note {
  id        String   @id @default(cuid())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String   @unique
  title     String
  contentJson     String   @default("{}")
  contentMarkdown String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  embeddings     Embedding[]
  flashcardDecks FlashcardDeck[]
  flashcards     Flashcard[]       @relation("NoteToFlashcards")
  quizzes        Quiz[]            @relation("NoteToQuizzes")
}

model PomodoroSession {
  id                 String   @id @default(cuid())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId             String
  task               Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId             String
  startTime          DateTime
  endTime            DateTime
  durationMinutes    Int
  reflectionMarkdown String?
  status             String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model FlashcardDeck {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  title       String
  sourceNote  Note?    @relation(fields: [sourceNoteId], references: [id])
  sourceNoteId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cards   Flashcard[]
  quizzes Quiz[]      @relation("DeckToQuizzes")
}

model Flashcard {
  id        String   @id @default(cuid())
  deck      FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  deckId    String
  note      Note?    @relation("NoteToFlashcards", fields: [noteId], references: [id])
  noteId    String?
  question  String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews FlashcardReview[]
}

model FlashcardReview {
  id           String   @id @default(cuid())
  flashcard    Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  flashcardId  String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  reviewedAt   DateTime @default(now())
  grade        Int
  nextReviewAt DateTime
  intervalDays Int
  easeFactor   Float
  updatedAt    DateTime @updatedAt
}

model Quiz {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  title       String
  sourceNote  Note?          @relation("NoteToQuizzes", fields: [sourceNoteId], references: [id])
  sourceNoteId String?
  deck        FlashcardDeck? @relation("DeckToQuizzes", fields: [deckId], references: [id])
  deckId      String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  questions QuizQuestion[]
  attempts  QuizAttempt[]
}

enum QuestionType {
  MCQ
  SHORT_ANSWER
}

model QuizQuestion {
  id             String   @id @default(cuid())
  quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId         String
  type           QuestionType
  promptMarkdown String
  options        Json?
  correctAnswer  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model QuizAttempt {
  id        String   @id @default(cuid())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId    String
  user      User     @relation("UserToQuizAttempts", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  score     Float
  takenAt   DateTime @default(now())
  details   Json?
  updatedAt DateTime @updatedAt
}

model Embedding {
  id        String   @id @default(cuid())
  user      User     @relation("UserToEmbeddings", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  note      Note?    @relation(fields: [noteId], references: [id], onDelete: Cascade)
  noteId    String?
  task      Task?    @relation("TaskToEmbeddings", fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String?
  chunkText String
  embedding Json
  createdAt DateTime @default(now())
}

// Logging for AI interactions / agent runs
model AgentRun {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?
  route     String?
  model     String?
  status    String?
  error     String?
  createdAt DateTime @default(now())

  events AIEvent[]

  @@index([userId])
}

model AIEvent {
  id        String   @id @default(cuid())
  run       AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId     String
  kind      String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([runId])
}

// Lightweight project entity for organizing tasks and linked notes
model Project {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks Task[]
}
